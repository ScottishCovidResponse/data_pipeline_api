language: generic

git:
  depth: false

env:
  global:
    # This was generated by running
    #
    #     travis encrypt ANACONDA_TOKEN=[secret]
    #
    # where [secret] was obtained from https://anaconda.org/ScottishCovidResponse/settings/access
    #
    # The current access token expires in 07/03/21. After that, a new one needs
    # to be issued. If it is not, the build will still succeed, but it won't be
    # possible to make new conda releases.
    #
    # Read more about travis secrets at: https://docs.travis-ci.com/user/encryption-keys#usage
    secure: T/HlWoAjdmlvdrHDPibEAwoAcJJS93Wn6LjkfxXu1jkc95u1VcgSYvajuGoXL3zHLcYRE/ASitsl5vFqyEL6J61pW0tzxtrdQbdaWiH4/mVzeMav8vcc6cHpdzNeE8vhAQh1pW0XyFfMQi3Rjj19h79uSVzufLFGgg6Toqvngk+hkUb0b4jsq/wUPvW3c1PIlANfGmLN6vZGQ4ch6ggQkThnRvgqBkqYn0plWraH8tiGIoD3SiXZEI1Tp933hDCy19pOlzm8pqbKZ5rghfHtk/9kczrSaRQfu+W9rYKD4hEMfPWDYWQitCiQdW5Vr1An7rLD2yt60hCZ3zxlDc2gglP67tFDWnMqvDPdP+ArxaitzKzA+0b/5u3XGmyNNj/nRod0CW6CtbpThjRrI0H+W9yekBcR2pZutR/gbhu1fv2BYzgYa40LHrIQ6zw8COS5ZJc1GWQKkAVnxjCCtTIhozo9xfbrHqcffk7quT4GoN1idQ3iJr23vpWiUhxjFfLCTZhKtpyougU4dRKyy2FP9E6OkAJrd5PkUFqtvzFw/wJu6Go6SmWbi8SmKJxjaqxyVoXOaOQpY5wvbeAYzBQufVMsd0uGWILV82QNN4SgFQYZRID0/LRtemy6+1+JGZcfcJ7cxObkCx9CT+PA2QE7TVxicPwRObj8fxnEkls8pQs=


matrix:
  include:
    - name: 'Conda Python with .yml-file'
      install:
        - sudo apt-get update && sudo apt-get install -y wget
        - wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh;
        - bash miniconda.sh -b -p $HOME/miniconda
        - source "$HOME/miniconda/etc/profile.d/conda.sh"
        - hash -r
        - conda config --set always_yes yes --set changeps1 no
        - conda update -q conda
        - conda env create environment.yml
        - conda activate data_pipeline_api
      script:
        - pytest --cov=data_pipeline_api
        - conda install setuptools_scm pkginfo conda-build anaconda-client
        - python setup.py bdist_wheel
        - scripts/upload_conda.sh
      after_success:
        - coverage xml
        - bash <(curl -s https://codecov.io/bash)

language: generic

git:
  depth: false

env:
  global:
    # This was generated by running
    #
    #     travis encrypt ANACONDA_TOKEN=[secret]
    #
    # where [secret] was obtained from https://anaconda.org/ScottishCovidResponse/settings/access
    #
    # The current access token expires in 07/03/21. After that, a new one needs
    # to be issued. If it is not, the build will still succeed, but it won't be
    # possible to make new conda releases.
    #
    # Read more about travis secrets at: https://docs.travis-ci.com/user/encryption-keys#usage
    secure: ainXhSLEW/D8LYJlmil36SeNfVAP1l9LLVewL/1xhSUgX8eP5MMiFbeaQB0qMNYYP3PKn2xNYuQRxTgmRGvvnDte6OXHv1Zs9LbFlTeZQm5sVEOt37Ey7hJxv+m7AHw7HHyB/tEdnY2NBk4LSLh8ZwFmP4bNhAsoGz0O0dpvnsd9ZNubATEAmsQGZd7wJIvKVq854xaiquS2sbU2kvAnH+DKHcy7Lmr3HQWnWFGPgVOTdR6VS9yxx+a+hJtFxGy+Zp6/t8hEtpF6JQyOglXWctTm8j9O8IDFOizIak+rbwq/5R946SBr82SUrLtsuJh8lVapa0E45hnvfcmbSG3JrPYstWxOl2V+rR1clPjvHieQHYlZ9Ix4skZK79bqRnd9mr4Go+uPx9v5KxAiP2T6aj9XEm2hTWdaUSITpWymMhPiJItHrbllftYPHTQSW9yPnnfqoyApeF4QY0U1tCjfZUypni0UWMl15vekfsBMT53rzNlrDTbfKvMHG0cUbD9EJE+LycVcQ/6MmuJDaZDZk8yVWpoCU5CenmooC+py4PiUnAfSPXQwRAtGplFbV746p3Ofe8sb54gVSKJPwqSExx9ccq89w9nMt06M1KX/r+OC6d94MnnuZknYGDOCoAkpYmHhnLZwwOA0H3rtC1LrjkNodkzH89Nde0aOTJQW0qs=


matrix:
  include:
    - name: 'Conda Python with .yml-file'
      language: python
      install:
        - sudo apt-get update && sudo apt-get install -y wget
        - wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh;
        - bash miniconda.sh -b -p $HOME/miniconda
        - source "$HOME/miniconda/etc/profile.d/conda.sh"
        - hash -r
        - conda config --set always_yes yes --set changeps1 no
        - conda update -q conda
        - conda env create environment.yml
        - conda activate data_pipeline_api
      script:
        - pytest --cov=data_pipeline_api
        - conda install setuptools_scm pkginfo conda-build anaconda-client
        - python setup.py bdist_wheel
        - scripts/upload_conda.sh
      after_success:
        - coverage xml
        - bash <(curl -s https://codecov.io/bash)

    - name: 'Java API build and publish'
      before_script:
        - "cd data_pipeline_api/java_api"
      jdk: openjdk11
      language: java
      script: "./gradlew build"
      after_success: "./gradlew publish"

